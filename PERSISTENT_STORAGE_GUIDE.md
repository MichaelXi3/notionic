# æŒä¹…åŒ–æµè§ˆæ¬¡æ•°å­˜å‚¨æŒ‡å—

## ğŸ¯ å­˜å‚¨æ–¹æ¡ˆæ¦‚è§ˆ

ä½ çš„æµè§ˆæ¬¡æ•°åŠŸèƒ½ç°åœ¨æ”¯æŒ**ä¸‰ç§å­˜å‚¨æ–¹å¼**ï¼Œä¼šè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„ï¼š

| å­˜å‚¨æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | æŒä¹…åŒ– | æ¨èåº¦ |
|---------|---------|--------|--------|
| **Redis** (Vercel KV) | ç”Ÿäº§ç¯å¢ƒ | âœ… æ˜¯ | â­â­â­â­â­ |
| **File** (JSON æ–‡ä»¶) | æœ¬åœ°å¼€å‘ | âœ… æ˜¯ | â­â­â­â­ |
| **Memory** (å†…å­˜) | åå¤‡æ–¹æ¡ˆ | âŒ å¦ | â­â­ |

## ğŸ“Š è‡ªåŠ¨æ£€æµ‹é€»è¾‘

```
æœ‰ KV ç¯å¢ƒå˜é‡? 
  â”œâ”€ Yes â†’ ä½¿ç”¨ Redis (ç”Ÿäº§ç¯å¢ƒ) âœ…
  â””â”€ No â†’ 
      æœ¬åœ°å¼€å‘ç¯å¢ƒ?
      â”œâ”€ Yes â†’ ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ âœ…
      â””â”€ No â†’ ä½¿ç”¨å†…å­˜å­˜å‚¨ âš ï¸
```

---

## ğŸ  æœ¬åœ°å¼€å‘ï¼ˆå·²é…ç½®å¥½ï¼‰

### å½“å‰çŠ¶æ€ï¼šâœ… æ–‡ä»¶å­˜å‚¨

ä½ ç°åœ¨è¿è¡Œ `npm run dev` æ—¶ï¼Œæµè§ˆæ¬¡æ•°ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š

```
.view-counts.json
```

**ç‰¹ç‚¹**ï¼š
- âœ… é‡å¯æœåŠ¡å™¨åæ•°æ®**ä¸ä¼šä¸¢å¤±**
- âœ… æ— éœ€ä»»ä½•é…ç½®
- âœ… å·²æ·»åŠ åˆ° `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ° Git
- ğŸ“ JSON æ ¼å¼ï¼Œå¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹å’Œç¼–è¾‘

### æŸ¥çœ‹æ•°æ®

```bash
# æŸ¥çœ‹å½“å‰æµè§ˆæ¬¡æ•°æ•°æ®
cat .view-counts.json
```

ç¤ºä¾‹å†…å®¹ï¼š
```json
{
  "my-first-post": 15,
  "hello-world": 42,
  "about": 7
}
```

---

## â˜ï¸ ç”Ÿäº§ç¯å¢ƒï¼ˆVercel + Redisï¼‰

### æ­¥éª¤ 1: åˆ›å»º Vercel KV æ•°æ®åº“

1. **ç™»å½• Vercel Dashboard**
   - è®¿é—®ï¼šhttps://vercel.com/dashboard

2. **è¿›å…¥ä½ çš„é¡¹ç›®**
   - é€‰æ‹©ä½ çš„ notionic é¡¹ç›®

3. **åˆ›å»º KV æ•°æ®åº“**
   - ç‚¹å‡» "Storage" æ ‡ç­¾
   - ç‚¹å‡» "Create Database"
   - é€‰æ‹© "KV (Redis)"
   - é€‰æ‹©å…è´¹çš„ Hobby è®¡åˆ’
   - ç‚¹å‡» "Create"

4. **è¿æ¥åˆ°é¡¹ç›®**
   - é€‰æ‹©ä½ çš„é¡¹ç›®
   - ç‚¹å‡» "Connect"

### æ­¥éª¤ 2: ç¯å¢ƒå˜é‡è‡ªåŠ¨é…ç½®

Vercel ä¼šè‡ªåŠ¨æ·»åŠ è¿™äº›ç¯å¢ƒå˜é‡åˆ°ä½ çš„é¡¹ç›®ï¼š

```bash
KV_REST_API_URL=https://xxx.kv.vercel-storage.com
KV_REST_API_TOKEN=your_token_here
# ... å…¶ä»– KV ç›¸å…³å˜é‡
```

### æ­¥éª¤ 3: é‡æ–°éƒ¨ç½²

```bash
# æ¨é€ä»£ç åˆ° GitHub
git add .
git commit -m "Add persistent view count storage"
git push

# Vercel ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²
```

### æ­¥éª¤ 4: éªŒè¯

éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®ä½ çš„ç½‘ç«™ï¼š

```bash
https://your-site.vercel.app
```

æµè§ˆæ¬¡æ•°ç°åœ¨ä¼š**æ°¸ä¹…ä¿å­˜**åœ¨ Redis ä¸­ï¼

---

## ğŸ”§ æœ¬åœ°æµ‹è¯• Redisï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ æƒ³åœ¨æœ¬åœ°æµ‹è¯• Redis åŠŸèƒ½ï¼š

### æ–¹æ³• 1: ä½¿ç”¨ Vercel KVï¼ˆæ¨èï¼‰

1. åœ¨ Vercel Dashboard åˆ›å»º KV æ•°æ®åº“
2. å¤åˆ¶ç¯å¢ƒå˜é‡åˆ°æœ¬åœ° `.env.local`ï¼š

```bash
# .env.local
NOTION_PAGE_ID=your_notion_id

# Vercel KV (ä» Vercel Dashboard å¤åˆ¶)
KV_REST_API_URL=https://xxx.kv.vercel-storage.com
KV_REST_API_TOKEN=your_token_here
KV_REST_API_READ_ONLY_TOKEN=your_read_only_token_here
```

3. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼š
```bash
npm run dev
```

### æ–¹æ³• 2: ä½¿ç”¨æœ¬åœ° Redis

å¦‚æœä½ æœ‰æœ¬åœ° Redis æœåŠ¡å™¨ï¼š

1. å®‰è£… Redisï¼š
```bash
# macOS
brew install redis
brew services start redis

# æˆ–ä½¿ç”¨ Docker
docker run -d -p 6379:6379 redis
```

2. å®‰è£… Redis å®¢æˆ·ç«¯ï¼š
```bash
npm install redis
```

3. ä¿®æ”¹ API ä½¿ç”¨æœ¬åœ° Redisï¼ˆéœ€è¦è‡ªå®šä¹‰ï¼‰

---

## ğŸ“ˆ å­˜å‚¨å®¹é‡å’Œé™åˆ¶

### Vercel KV (Redis) - Hobby è®¡åˆ’ï¼ˆå…è´¹ï¼‰

| æŒ‡æ ‡ | é™åˆ¶ |
|------|------|
| å­˜å‚¨ç©ºé—´ | 256 MB |
| æ¯æœˆè¯·æ±‚æ•° | 10,000 |
| æ¯å¤©è¯·æ±‚æ•° | 3,000 |
| æ•°æ®æŒä¹…åŒ– | âœ… æ˜¯ |

**å¤Ÿç”¨å—ï¼Ÿ**

å‡è®¾ï¼š
- æ¯ç¯‡æ–‡ç« å¹³å‡ 100 æ¬¡æµè§ˆ/æœˆ
- æ¯æ¬¡æµè§ˆ = 2 ä¸ªè¯·æ±‚ï¼ˆ1 GET + 1 POSTï¼‰

å¯ä»¥æ”¯æŒï¼š
- **25 ç¯‡æ–‡ç« ** Ã— 100 æ¬¡æµè§ˆ Ã— 2 è¯·æ±‚ = 5,000 è¯·æ±‚/æœˆ âœ…

å¦‚æœæµé‡æ›´å¤§ï¼Œå¯ä»¥å‡çº§åˆ° Pro è®¡åˆ’ã€‚

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ–¹å¼

åœ¨ API ä¸­æ·»åŠ æ—¥å¿—ï¼ˆä¸´æ—¶è°ƒè¯•ç”¨ï¼‰ï¼š

```typescript
// src/pages/api/views/[slug].ts
console.log("Storage type:", getStorageType())
```

æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š
```bash
# æœ¬åœ°å¼€å‘
åœ¨ç»ˆç«¯æŸ¥çœ‹

# Vercel
è®¿é—® Vercel Dashboard â†’ Functions â†’ Logs
```

### æ£€æŸ¥æ•°æ®

**Redis (Vercel KV)**ï¼š
- è®¿é—® Vercel Dashboard â†’ Storage â†’ ä½ çš„ KV æ•°æ®åº“
- ä½¿ç”¨ Data Browser æŸ¥çœ‹æ•°æ®

**æ–‡ä»¶å­˜å‚¨**ï¼š
```bash
cat .view-counts.json
```

**å†…å­˜å­˜å‚¨**ï¼š
- æ— æ³•æŸ¥çœ‹ï¼ˆä»…åœ¨è¿è¡Œæ—¶å­˜åœ¨ï¼‰

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ•°æ®ä»ç„¶åœ¨é‡å¯åä¸¢å¤±

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç¡®è®¤ `NODE_ENV` æ˜¯ `development`
- [ ] ç¡®è®¤é¡¹ç›®æ ¹ç›®å½•æœ‰å†™å…¥æƒé™
- [ ] æŸ¥çœ‹æ˜¯å¦ç”Ÿæˆäº† `.view-counts.json` æ–‡ä»¶
- [ ] æ£€æŸ¥ç»ˆç«¯æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶
echo "{}" > .view-counts.json

# æ£€æŸ¥æƒé™
ls -la .view-counts.json

# é‡å¯æœåŠ¡å™¨
npm run dev
```

### é—®é¢˜ 2: Vercel ä¸Šæ•°æ®ä¸¢å¤±

**å¯èƒ½åŸå› **ï¼š
- KV æ•°æ®åº“æœªè¿æ¥åˆ°é¡¹ç›®
- ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
1. è®¿é—® Vercel Dashboard
2. è¿›å…¥é¡¹ç›® â†’ Storage
3. ç¡®è®¤ KV æ•°æ®åº“å·²è¿æ¥
4. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
5. é‡æ–°éƒ¨ç½²é¡¹ç›®

### é—®é¢˜ 3: API å“åº”æ…¢

**å¯èƒ½åŸå› **ï¼š
- Redis è¿æ¥å»¶è¿Ÿ
- æ–‡ä»¶ I/O æ…¢

**è§£å†³æ–¹æ³•**ï¼š
- Redis: æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ–‡ä»¶: æœ¬åœ°å¼€å‘æ…¢æ˜¯æ­£å¸¸çš„ï¼Œç”Ÿäº§ç¯å¢ƒç”¨ Redis

---

## ğŸ“Š è¿ç§»ç°æœ‰æ•°æ®

### ä»å†…å­˜è¿ç§»åˆ°æ–‡ä»¶

æ•°æ®ä¼šä¸¢å¤±ï¼Œå› ä¸ºå†…å­˜æ•°æ®åœ¨æœåŠ¡å™¨é‡å¯åæ¶ˆå¤±ã€‚

### ä»æ–‡ä»¶è¿ç§»åˆ° Redis

ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼ˆåˆ›å»ºåè¿è¡Œä¸€æ¬¡ï¼‰ï¼š

```javascript
// scripts/migrate-to-redis.js
const { kv } = require('@vercel/kv')
const fs = require('fs')

async function migrate() {
  // è¯»å–æ–‡ä»¶æ•°æ®
  const data = JSON.parse(fs.readFileSync('.view-counts.json', 'utf-8'))
  
  // ä¸Šä¼ åˆ° Redis
  for (const [slug, views] of Object.entries(data)) {
    await kv.set(`views:${slug}`, views)
    console.log(`Migrated: ${slug} = ${views}`)
  }
  
  console.log('Migration complete!')
}

migrate()
```

è¿è¡Œï¼š
```bash
node scripts/migrate-to-redis.js
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„æµè§ˆæ¬¡æ•°åŠŸèƒ½æ˜¯**å®Œå…¨æŒä¹…åŒ–**çš„ï¼š

- âœ… **æœ¬åœ°å¼€å‘**ï¼šä½¿ç”¨æ–‡ä»¶å­˜å‚¨ï¼ˆ`.view-counts.json`ï¼‰
- âœ… **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ Vercel KV (Redis)
- âœ… **æ•°æ®å®‰å…¨**ï¼šè‡ªåŠ¨å¤‡ä»½ï¼Œä¸ä¼šä¸¢å¤±

### ä¸‹ä¸€æ­¥

1. ç»§ç»­æœ¬åœ°å¼€å‘æµ‹è¯•
2. å‡†å¤‡å¥½åéƒ¨ç½²åˆ° Vercel
3. åœ¨ Vercel åˆ›å»º KV æ•°æ®åº“
4. äº«å—ä½ çš„æŒä¹…åŒ–æµè§ˆæ¬¡æ•°åŠŸèƒ½ï¼

---

**æœ‰é—®é¢˜ï¼Ÿ** æŸ¥çœ‹æ—¥å¿—æˆ–åœ¨ç»ˆç«¯è¿è¡Œï¼š
```bash
cat .view-counts.json  # æŸ¥çœ‹æœ¬åœ°æ•°æ®
```

